name: Commit Artifacts

on:
  status
  # push:
  #   branches: [main, lt/artifacts]
  # pull_request:

jobs:
  download_artifacts:
    runs-on: ubuntu-latest
    if: ${{ github.event.state == 'success' }}
    steps:
      - name: TODO RENAME ME
        uses: actions/github-script@v6
        with:
          script: |
            const { repo, owner, sha } = context;
            const statuses = await github.rest.repos.listCommitStatusesForRef({ owner, repo, ref: sha });
            for (const status of statuses) {
              console.log(status);
              if (
                status.context === 'ci/cirleci: process_artifacts_combined' &&
                status.state === 'success'
              ) {
                // The status does not include a build ID, but we can extract it
                // from the URL. I couldn't find a better way to do this.
                const ciBuildId = /\/facebook\/react\/([0-9]+)/.exec(
                  status.target_url,
                )[1];
                if (Number.parseInt(ciBuildId, 10) + '' === ciBuildId) {
                  const artifactsUrl =
                    `https://circleci.com/api/v1.1/project/github/facebook/react/${ciBuildId}/artifacts`;
                  console.log(artifactsUrl);
                }
              }
            }

  # get build status for commit: https://api.github.com/repos/facebook/react/commits/${ref}/status
  #   maybe use the scripting api for this?
  # find process_artifacts_combined status, get the cirleci ID off of the target_url
  #   eg https://api.github.com/repos/facebook/react/commits/56ffca8b9e4e49ad46136fe705203afc2d20fd9f/status
  #   "target_url": "https://circleci.com/gh/facebook/react/589148",
  # then hit circle to download the artifacts
  #  https://circleci.com/api/v1.1/project/github/facebook/react/589148/artifacts
  # maybe we can upload the artifact to github?
  #  https://github.com/actions/upload-artifact

  # commit_artifacts:
  #   runs-on: ubuntu-latest
  #   steps:
      # maybe unzip the tgz then put it in a folder keyed by commit ref
      #   cuz difftrain can't process the tgz
      # git commit it to a separate branch
      #
      # elsewhere: would be nice to send a status to the pr if the difftrain ci was started and just
      # say if any failures detected (without any details)
